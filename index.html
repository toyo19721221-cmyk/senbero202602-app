<!doctype html>
<html lang="ja" class="h-full">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Á≥∏Â≥∂„Çª„É≥„Éô„É≠ 2026</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Zen+Kaku+Gothic+New:wght@400;700;900&display=swap" rel="stylesheet">
  <style>
    body { box-sizing: border-box; font-family: 'Zen Kaku Gothic New', sans-serif; -webkit-tap-highlight-color: transparent; }
    .shop-card { transition: all 0.2s ease; cursor: pointer; }
    .shop-card:active { transform: scale(0.97); }
    #video-container { position: relative; width: 100%; max-width: 400px; aspect-ratio: 1/1; overflow: hidden; border-radius: 1.5rem; border: 4px solid white; box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1); }
    #video { width: 100%; height: 100%; object-fit: cover; }
    .scan-line { position: absolute; width: 100%; height: 3px; background: #ff6b6b; top: 0; left: 0; animation: scan 2s linear infinite; }
    @keyframes scan { 0% { top: 0; } 100% { top: 100%; } }
  </style>
</head>
<body class="h-full bg-[#fff5e6] text-[#2d3436]">
  <div id="app" class="w-full h-full overflow-auto pb-20"></div>

  <div id="qr-modal" class="hidden fixed inset-0 z-[3000] bg-black/90 flex flex-col items-center justify-center p-6">
    <div id="video-container">
      <video id="video"></video>
      <div class="scan-line"></div>
    </div>
    <button onclick="closeScanner()" class="mt-8 bg-white text-black px-12 py-3 rounded-full font-bold">Êàª„Çã</button>
    <canvas id="canvas" hidden></canvas>
  </div>

  <div id="detail-modal" class="hidden fixed inset-0 z-[2000] bg-black/60 flex items-center justify-center p-4 backdrop-blur-sm" onclick="closeDetail()">
    <div class="bg-white w-full max-w-sm rounded-3xl overflow-hidden shadow-2xl" onclick="event.stopPropagation()">
      <div id="detail-image" class="w-full h-48 bg-gray-200 bg-cover bg-center"></div>
      <div class="p-6">
        <h2 id="detail-name" class="text-2xl font-black mb-1"></h2>
        <a id="detail-address-link" target="_blank" rel="noopener noreferrer" class="text-sm text-blue-500 underline mb-4 block hover:text-blue-700 transition-colors"></a>
        <div class="bg-orange-50 p-4 rounded-xl mb-4 border border-orange-100">
          <p class="text-xs font-bold text-orange-400 mb-1 uppercase">„Çª„É≥„Éô„É≠ÁâπÂÖ∏</p>
          <p id="detail-special" class="font-bold text-lg text-[#ff6b6b]"></p>
        </div>
        <p id="detail-desc" class="text-sm leading-relaxed mb-6 text-gray-600"></p>
        <button onclick="closeDetail()" class="w-full bg-gray-100 py-4 rounded-2xl font-bold text-gray-500">Èñâ„Åò„Çã</button>
      </div>
    </div>
  </div>

  <script>
    const referenceShops = [
      { 
        id: "itoshima_1", 
        name: "music bar en „Éü„É•„Éº„Ç∏„ÉÉ„ÇØ„Éê„Éº „Ç®„É≥/Á∏Å", 
        address: "Á¶èÂ≤°ÁúåÁ≥∏Â≥∂Â∏ÇÂâçÂéü‰∏≠Â§Æ2-1-21", 
        special: "„Åä„Åô„Åô„ÇÅ„Éâ„É™„É≥„ÇØ1ÊùØ„Çµ„Éº„Éì„Çπ", 
        qrCode: "MusicBarEn_1",
        description: "Èü≥Ê•Ω„Å®„ÅäÈÖí„ÇíÊ•Ω„Åó„ÇÅ„ÇãÂøÉÂú∞„Çà„ÅÑÁ©∫Èñì„ÄÇÂâçÂéü„ÅÆÂ§ú„ÇíÂΩ©„Çã„Éü„É•„Éº„Ç∏„ÉÉ„ÇØ„Éê„Éº„Åß„Åô„ÄÇ",
        // „ÅîÊèêÁ§∫„ÅÑ„Åü„Å†„ÅÑ„ÅüÁîªÂÉè„ÅÆURL„ÇíÂèçÊò†„Åó„Åæ„Åó„Åü
        image: "http://googleusercontent.com/image_generation_content/0"
      },
      { 
        id: "itoshima_2", 
        name: "„Çπ„Éä„ÉÉ„ÇØ „É≠„Éº„Ç∫„Éé„Ç¢„Éº„É´", 
        address: "Á¶èÂ≤°ÁúåÁ≥∏Â≥∂Â∏ÇÂâçÂéü‰∏≠Â§Æ2-3-2", 
        special: "„Åä„Å§„Åæ„Åø1ÂìÅ„Çµ„Éº„Éì„Çπ", 
        qrCode: "RoseNoir_2",
        description: "„Ç¢„ÉÉ„Éà„Éõ„Éº„É†„Å™Èõ∞Âõ≤Ê∞ó„Åß„ÄÅÂú∞ÂÖÉ„ÅÆÊñπ„Å´ÊÑõ„Åï„Çå„Çã„Çπ„Éä„ÉÉ„ÇØ„Åß„Åô„ÄÇÊ•Ω„Åó„ÅÑÂ§ú„Çí‰∏ÄÁ∑í„Å´ÈÅé„Åî„Åó„Åæ„Åó„Çá„ÅÜ„ÄÇ",
        image: "https://images.unsplash.com/photo-1572116469696-31de0f17cc34?w=400"
      },
      { 
        id: "itoshima_3", 
        name: "CURRENT", 
        address: "Á¶èÂ≤°ÁúåÁ≥∏Â≥∂Â∏ÇÂøóÊë©ÈáéÂåó2290", 
        special: "Ëá™ÂÆ∂Ë£Ω„Éü„Éã„Éá„Ç∂„Éº„Éà", 
        qrCode: "Current_3",
        description: "ÈáéÂåóÊµ∑Â≤∏„ÇíË¶ãÊ∏°„ÅôÁµ∂ÊôØ„Ç´„Éï„ÇßÔºÜ„É¨„Çπ„Éà„É©„É≥„ÄÇ",
        image: "https://images.unsplash.com/photo-1517248135467-4c7edcad34c4?w=400"
      }
    ];

    let visitedShops = JSON.parse(localStorage.getItem('senbero_visited')) || [];
    let videoStream = null;

    function renderApp() {
      const visitedCount = visitedShops.length;
      const progressPercent = (visitedCount / referenceShops.length) * 100;
      const app = document.getElementById('app');
      
      let shopListHtml = referenceShops.map(shop => {
        const isVisited = visitedShops.some(v => v.shop_id === shop.id);
        return `
          <div onclick="openDetail('${shop.id}')" class="shop-card bg-white p-2 rounded-[2rem] shadow-lg border-4 ${isVisited ? 'border-[#ff6b6b]' : 'border-white'} relative mb-6">
            <div class="flex items-center">
              <div class="w-20 h-20 rounded-2xl bg-gray-100 bg-cover bg-center" style="background-image:url('${shop.image}')"></div>
              <div class="flex-1 ml-4 pr-4">
                <h3 class="font-black text-lg mb-1">${shop.name}</h3>
                <p class="text-[10px] text-gray-400">${shop.address}</p>
                <div class="flex justify-between items-center mt-2">
                  <span class="text-[10px] bg-red-50 text-[#ff6b6b] px-2 py-1 rounded">${shop.special}</span>
                  <span>${isVisited ? '‚úÖ' : '‚â´'}</span>
                </div>
              </div>
            </div>
          </div>
        `;
      }).join('');

      app.innerHTML = `
        <div class="max-w-2xl mx-auto p-6">
          <header class="text-center my-8">
            <h1 class="text-3xl font-black text-[#ff6b6b]">Á≥∏Â≥∂„Çª„É≥„Éô„É≠ 2026</h1>
          </header>
          <div class="flex justify-center mb-8">
            <button onclick="openScanner()" class="bg-[#ff6b6b] text-white font-bold px-8 py-4 rounded-full shadow-lg">üì∏ QR„Çπ„Ç≠„É£„É≥</button>
          </div>
          <div class="bg-white p-6 rounded-3xl shadow-md mb-8">
            <p class="text-sm font-bold text-gray-400 mb-2">ÁèæÂú®„ÅÆ„Çπ„Çø„É≥„ÉóÔºö${visitedCount} / ${referenceShops.length}</p>
            <div class="w-full h-3 bg-gray-100 rounded-full"><div class="h-full bg-[#ff6b6b] rounded-full" style="width:${progressPercent}%"></div></div>
          </div>
          ${shopListHtml}
        </div>
      `;
    }

    function openDetail(shopId) {
      const shop = referenceShops.find(s => s.id === shopId);
      if (!shop) return;
      document.getElementById('detail-name').innerText = shop.name;
      
      const addressLink = document.getElementById('detail-address-link');
      addressLink.innerText = "üìç " + shop.address;
      
      const query = encodeURIComponent(shop.name + " " + shop.address);
      addressLink.href = "https://www.google.com/maps/search/?api=1&query=" + query;
      
      document.getElementById('detail-special').innerText = shop.special;
      document.getElementById('detail-desc').innerText = shop.description;
      document.getElementById('detail-image').style.backgroundImage = "url('" + shop.image + "')";
      document.getElementById('detail-modal').classList.remove('hidden');
    }

    function closeDetail() { document.getElementById('detail-modal').classList.add('hidden'); }

    async function openScanner() {
      const modal = document.getElementById('qr-modal');
      const video = document.getElementById('video');
      modal.classList.remove('hidden');
      try {
        videoStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
        video.srcObject = videoStream;
        video.setAttribute("playsinline", true);
        video.play();
        requestAnimationFrame(tick);
      } catch (err) { alert("„Ç´„É°„É©„ÅåËµ∑Âãï„Åß„Åç„Åæ„Åõ„Çì"); closeScanner(); }
    }

    function closeScanner() {
      document.getElementById('qr-modal').classList.add('hidden');
      if (videoStream) videoStream.getTracks().forEach(t => t.stop());
    }

    function tick() {
      const video = document.getElementById('video');
      const canvasElement = document.getElementById('canvas');
      const canvas = canvasElement.getContext('2d');
      if (video.readyState === video.HAVE_ENOUGH_DATA) {
        canvasElement.height = video.videoHeight;
        canvasElement.width = video.videoWidth;
        canvas.drawImage(video, 0, 0, canvasElement.width, canvasElement.height);
        const imgData = canvas.getImageData(0, 0, canvasElement.width, canvasElement.height);
        const code = jsQR(imgData.data, imgData.width, imgData.height);
        if (code) {
          const shop = referenceShops.find(s => s.qrCode === code.data);
          if (shop) {
            if (!visitedShops.some(v => v.shop_id === shop.id)) {
              visitedShops.push({ shop_id: shop.id });
              localStorage.setItem('senbero_visited', JSON.stringify(visitedShops));
              renderApp();
              alert(shop.name + "„ÅÆ„Çπ„Çø„É≥„ÉóGET!");
            } else { alert("ÂèñÂæóÊ∏à„Åø„Åß„Åô"); }
            closeScanner(); return;
          }
        }
      }
      if (!document.getElementById('qr-modal').classList.contains('hidden')) requestAnimationFrame(tick);
    }

    renderApp();
  </script>
</body>
</html>
