<!doctype html>
<html lang="ja" class="h-full">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç³¸å³¶ã‚»ãƒ³ãƒ™ãƒ­ 2026</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Zen+Kaku+Gothic+New:wght@400;700;900&display=swap" rel="stylesheet">
  <style>
    body { box-sizing: border-box; font-family: 'Zen Kaku Gothic New', sans-serif; -webkit-tap-highlight-color: transparent; }
    .shop-card { transition: all 0.2s ease; cursor: pointer; }
    .shop-card:active { transform: scale(0.97); }
    #video-container { position: relative; width: 100%; max-width: 400px; aspect-ratio: 1/1; overflow: hidden; border-radius: 1.5rem; border: 4px solid white; box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1); }
    #video { width: 100%; height: 100%; object-fit: cover; }
    .scan-line { position: absolute; width: 100%; height: 3px; background: #ff6b6b; top: 0; left: 0; animation: scan 2s linear infinite; }
    @keyframes scan { 0% { top: 0; } 100% { top: 100%; } }
  </style>
</head>
<body class="h-full bg-[#fff5e6] text-[#2d3436]">
  <div id="app" class="w-full h-full overflow-auto pb-20"></div>

  <div id="qr-modal" class="hidden fixed inset-0 z-[3000] bg-black/90 flex flex-col items-center justify-center p-6">
    <div id="video-container">
      <video id="video"></video>
      <div class="scan-line"></div>
    </div>
    <button onclick="closeScanner()" class="mt-8 bg-white text-black px-12 py-3 rounded-full font-bold">æˆ»ã‚‹</button>
    <canvas id="canvas" hidden></canvas>
  </div>

  <div id="detail-modal" class="hidden fixed inset-0 z-[2000] bg-black/60 flex items-center justify-center p-4 backdrop-blur-sm" onclick="closeDetail()">
    <div class="bg-white w-full max-w-sm max-h-[90vh] rounded-3xl overflow-y-auto shadow-2xl" onclick="event.stopPropagation()">
      <div id="detail-image" class="w-full h-48 bg-gray-200 bg-cover bg-center shrink-0"></div>
      <div class="p-6">
        <div id="detail-visited-badge" class="hidden mb-3 bg-red-500 text-white text-xs font-bold px-3 py-1 rounded-full w-fit">
          âœ“ æ¥åº—æ¸ˆã¿
        </div>

        <h2 id="detail-name" class="text-2xl font-black mb-1"></h2>
        
        <a id="detail-address-link" target="_blank" rel="noopener noreferrer" class="text-sm text-blue-500 underline mb-4 block hover:text-blue-700"></a>
        
        <a id="detail-tel-link" class="w-full bg-green-500 text-white py-3 rounded-xl font-bold flex items-center justify-center gap-2 mb-4 shadow-sm active:bg-green-600 transition-colors">
          <span>ğŸ“</span> ãŠåº—ã«é›»è©±ã™ã‚‹
        </a>
        
        <div class="bg-orange-50 p-4 rounded-xl mb-4 border border-orange-100">
          <p class="text-[10px] font-bold text-orange-400 mb-1 tracking-widest uppercase flex items-center gap-1">
            <span>ğŸ´</span> ãƒ•ãƒ¼ãƒ‰
          </p>
          <p id="detail-food" class="font-bold text-lg text-[#ff6b6b] leading-tight"></p>
        </div>

        <p id="detail-desc" class="text-sm leading-relaxed mb-6 text-gray-600"></p>
        
        <button onclick="closeDetail()" class="w-full bg-gray-100 py-4 rounded-2xl font-bold text-gray-500 sticky bottom-0 border-t border-gray-50 mt-4">é–‰ã˜ã‚‹</button>
      </div>
    </div>
  </div>

  <script>
    const referenceShops = [
      { 
        id: "itoshima_1", 
        name: "music bar en ãƒŸãƒ¥ãƒ¼ã‚¸ãƒƒã‚¯ãƒãƒ¼ ã‚¨ãƒ³/ç¸", 
        address: "ç¦å²¡çœŒç³¸å³¶å¸‚å‰åŸä¸­å¤®2-1-21", 
        tel: "092-332-9011",
        food: "ãŠã¤ã¾ã¿3ç¨®ç››ã‚Šåˆã‚ã›", 
        qrCode: "MusicBarEn_1",
        description: "éŸ³æ¥½ã¨ãŠé…’ã‚’æ¥½ã—ã‚ã‚‹å¿ƒåœ°ã‚ˆã„ç©ºé–“ã€‚å‰åŸã®å¤œã‚’å½©ã‚‹ãƒŸãƒ¥ãƒ¼ã‚¸ãƒƒã‚¯ãƒãƒ¼ã§ã™ã€‚",
        image: "en.jpg" 
      },
      { 
        id: "itoshima_2", 
        name: "ã‚¹ãƒŠãƒƒã‚¯ ãƒ­ãƒ¼ã‚ºãƒã‚¢ãƒ¼ãƒ«", 
        address: "ç¦å²¡çœŒç³¸å³¶å¸‚å‰åŸä¸­å¤®2-3-2", 
        tel: "092-324-1111", 
        food: "è‡ªå®¶è£½ãƒãƒ†ãƒˆã‚µãƒ©ãƒ€ & ä¹¾ãç‰©", 
        qrCode: "RoseNoir_2",
        description: "ã‚¢ãƒƒãƒˆãƒ›ãƒ¼ãƒ ãªé›°å›²æ°—ã§ã€åœ°å…ƒã®æ–¹ã«æ„›ã•ã‚Œã‚‹ã‚¹ãƒŠãƒƒã‚¯ã§ã™ã€‚",
        image: "https://images.unsplash.com/photo-1572116469696-31de0f17cc34?w=400"
      },
      { 
        id: "itoshima_3", 
        name: "CURRENT", 
        address: "ç¦å²¡çœŒç³¸å³¶å¸‚å¿—æ‘©é‡åŒ—2290", 
        tel: "092-330-5000", 
        food: "ç³¸å³¶é‡èœã®ãƒŸãƒ‹ã‚­ãƒƒã‚·ãƒ¥", 
        qrCode: "Current_3",
        description: "é‡åŒ—æµ·å²¸ã‚’è¦‹æ¸¡ã™çµ¶æ™¯ã‚«ãƒ•ã‚§ï¼†ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³ã€‚",
        image: "https://images.unsplash.com/photo-1517248135467-4c7edcad34c4?w=400"
      }
    ];

    let visitedShops = JSON.parse(localStorage.getItem('senbero_visited')) || [];
    let videoStream = null;

    function renderApp() {
      const visitedCount = visitedShops.length;
      const progressPercent = (visitedCount / referenceShops.length) * 100;
      const app = document.getElementById('app');
      
      let shopListHtml = referenceShops.map(shop => {
        const isVisited = visitedShops.some(v => v.shop_id === shop.id);
        return `
          <div onclick="openDetail('${shop.id}')" class="shop-card bg-white p-2 rounded-[2rem] shadow-lg border-4 ${isVisited ? 'border-[#ff6b6b]' : 'border-white'} relative mb-6">
            <div class="flex items-center">
              <div class="w-20 h-20 rounded-2xl bg-gray-100 bg-cover bg-center" style="background-image:url('${shop.image}')"></div>
              <div class="flex-1 ml-4 pr-4">
                <div class="flex justify-between items-start">
                  <h3 class="font-black text-lg mb-1 leading-tight flex-1">${shop.name}</h3>
                  ${isVisited ? '<span class="text-[#ff6b6b] font-bold text-[10px] bg-red-50 px-2 py-1 rounded-lg shrink-0">æ¥åº—æ¸ˆã¿ âœ“</span>' : ''}
                </div>
                <p class="text-[10px] text-gray-400 mb-2">${shop.address}</p>
                
                <div class="mt-1">
                  <p class="text-[9px] text-orange-400 font-bold mb-0 flex items-center gap-1 uppercase tracking-tighter">
                    <span>ğŸ´</span> ãƒ•ãƒ¼ãƒ‰
                  </p>
                  <span class="text-xs font-bold text-[#ff6b6b] leading-tight">${shop.food}</span>
                </div>
              </div>
            </div>
          </div>
        `;
      }).join('');

      app.innerHTML = `
        <div class="max-w-2xl mx-auto p-6">
          <header class="text-center my-8">
            <h1 class="text-3xl font-black text-[#ff6b6b]">ç³¸å³¶ã‚»ãƒ³ãƒ™ãƒ­ 2026</h1>
          </header>
          <div class="flex justify-center mb-8">
            <button onclick="openScanner()" class="bg-[#ff6b6b] text-white font-bold px-8 py-4 rounded-full shadow-lg">ğŸ“¸ QRã‚¹ã‚­ãƒ£ãƒ³</button>
          </div>
          <div class="bg-white p-6 rounded-3xl shadow-md mb-8">
            <p class="text-sm font-bold text-gray-400 mb-2">ç¾åœ¨ã®ã‚¹ã‚¿ãƒ³ãƒ—ï¼š${visitedCount} / ${referenceShops.length}</p>
            <div class="w-full h-3 bg-gray-100 rounded-full"><div class="h-full bg-[#ff6b6b] rounded-full" style="width:${progressPercent}%"></div></div>
          </div>
          ${shopListHtml}
        </div>
      `;
    }

    function openDetail(shopId) {
      const shop = referenceShops.find(s => s.id === shopId);
      if (!shop) return;
      
      const isVisited = visitedShops.some(v => v.shop_id === shop.id);
      const visitedBadge = document.getElementById('detail-visited-badge');
      
      // æ¥åº—æ¸ˆã¿ãƒãƒƒã‚¸ã®è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
      if (isVisited) {
        visitedBadge.classList.remove('hidden');
      } else {
        visitedBadge.classList.add('hidden');
      }

      document.getElementById('detail-name').innerText = shop.name;
      
      const addressLink = document.getElementById('detail-address-link');
      addressLink.innerText = "ğŸ“ " + shop.address;
      addressLink.href = "https://www.google.com/maps/search/?api=1&query=" + encodeURIComponent(shop.name + " " + shop.address);
      
      const telLink = document.getElementById('detail-tel-link');
      if (shop.tel) {
        telLink.href = "tel:" + shop.tel.replace(/-/g, '');
        telLink.style.display = "flex";
      } else {
        telLink.style.display = "none";
      }
      
      document.getElementById('detail-food').innerText = shop.food;
      document.getElementById('detail-desc').innerText = shop.description;
      document.getElementById('detail-image').style.backgroundImage = "url('" + shop.image + "')";
      document.getElementById('detail-modal').classList.remove('hidden');
      document.querySelector('#detail-modal > div').scrollTop = 0;
    }

    function closeDetail() { document.getElementById('detail-modal').classList.add('hidden'); }

    async function openScanner() {
      const modal = document.getElementById('qr-modal');
      const video = document.getElementById('video');
      modal.classList.remove('hidden');
      try {
        videoStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
        video.srcObject = videoStream;
        video.setAttribute("playsinline", true);
        video.play();
        requestAnimationFrame(tick);
      } catch (err) { alert("ã‚«ãƒ¡ãƒ©ãŒèµ·å‹•ã§ãã¾ã›ã‚“"); closeScanner(); }
    }

    function closeScanner() {
      document.getElementById('qr-modal').classList.add('hidden');
      if (videoStream) videoStream.getTracks().forEach(t => t.stop());
    }

    function tick() {
      const video = document.getElementById('video');
      const canvasElement = document.getElementById('canvas');
      const canvas = canvasElement.getContext('2d');
      if (video.readyState === video.HAVE_ENOUGH_DATA) {
        canvasElement.height = video.videoHeight;
        canvasElement.width = video.videoWidth;
        canvas.drawImage(video, 0, 0, canvasElement.width, canvasElement.height);
        const imgData = canvas.getImageData(0, 0, canvasElement.width, canvasElement.height);
        const code = jsQR(imgData.data, imgData.width, imgData.height);
        if (code) {
          const shop = referenceShops.find(s => s.qrCode === code.data);
          if (shop) {
            if (!visitedShops.some(v => v.shop_id === shop.id)) {
              visitedShops.push({ shop_id: shop.id });
              localStorage.setItem('senbero_visited', JSON.stringify(visitedShops));
              confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
              renderApp();
              alert(shop.name + "ã®ã‚¹ã‚¿ãƒ³ãƒ—GET!");
            } else { alert("å–å¾—æ¸ˆã¿ã§ã™"); }
            closeScanner(); return;
          }
        }
      }
      if (!document.getElementById('qr-modal').classList.contains('hidden')) requestAnimationFrame(tick);
    }

    renderApp();
  </script>
</body>
</html>
